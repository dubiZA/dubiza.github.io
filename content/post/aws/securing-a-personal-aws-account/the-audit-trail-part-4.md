---
title: "Part 4 - AWS For Personal Use/Learning: The Audit Trail"
date: 2021-06-04T07:14:46-06:00
draft: false
toc: true
tags:
  - aws
  - reference
  - cloud security
  - amazon guardduty 
  - aws organizations
---
_This is the fourth post in what is a multi-part series on some suggestions based on AWS Well-Architected Framework best practices focused on setting up an AWS account(s) for personal use and learning. For other parts in the series see:_
  - _[Part 1 - AWS For Personal Use/Learning: Secure Multi-Account Setup][part-1]_
  - _[Part 2 - AWS For Personal Use/Learning: Identity and Access Management][part-2]_
  - _[Part 3 - AWS For Personal Use/Learning: Account Level Guardrails][part-3]_
  - _[Part 5 - AWS For Personal Use/Learning: Intelligent Threat Detection][part-5]_

An important part of security is attribution or accountability - who did what (also helpful is when and sometimes from where). With so many AWS services on offer and what must be over 1000 API calls across these services, being able to track and hunt for badness is important. To this end, AWS provides the CloudTrail service. CloudTrail keeps a record of all the API calls made on the control plane and data plane of AWS and creates a logs of all the activity. This log can then be used for troubleshooting, security, and more.

FYI - This post is going to be much shorter than previous posts. CloudTrail integrates with AWS Organizations and makes enabling control plan logging across all accounts easy. When creating and enabling a trail in the management account and checking the box for making it an organization trail, CloudTrail will create a few dependant resources/roles in the member accounts that allows it work with CloudTrail in those accounts. One of the great benefits of enabling an organization trail, is that only the org management account can enable and disable the trail across the org. Member accounts are unable to modify or delete the trail in their individual accounts.

I should also point out that CloudTrail offers a free tier of service. The initial trail is always free for what AWS calls management events. There are three types of events that can be enabled on a trail:

  1. Management Events
  2. Data Events
      1. S3
      2. Lambda
      3. DynamoDB
  3. Insights

Management events are the control plane activities that take place in an account - interactions with various services. Data events deal more this data access (management events for S3 would be things like creating, deleting or modifying S3 buckets. Data events would be things like adding, deleting and retrieving objects in the bucket). Insights generates, well, insights into things like weird behaviors etc. There is no free tier coverage for data and insight events.

## Creating the Trail
Creating the trail in the management console is pretty straightforward:

  - Navigate to the CloudTrail service. Expand the left side navigation by clicking the "hamburger" menu
  - In the left side navigation, click "Trails"
  - On the "Trails" dashboard, click "Create trail"

![Enabling SSO](/post/aws/securing-a-personal-aws-account/images/aws_ct_create_trail.png)

  - On the first page of the create trail page, fill in the necessary information
  - Give the trail a name
  - Check the box for "Enable for all accounts in my organization"
  - Either create a new bucket or select an existing bucket (I created an S3 bucket ahead of time with a configuration I wanted like enabling bucket level encryption using AWS SSE-KMS with an AWS managed KMS key to avoid paying for a CMK)
      - Optionally, if using an existing bucket, provide a prefix for the trail. The CloudTrail service will log to `my-organization-bucket/AWSLogs/o-exampleorgid/exampleaccountid` by default. If a prefix is used, it will log to `my-organization-bucket/exampleprefix/AWSLogs/o-exampleorgid/exampleaccountid`
  - Optionally, enable log file SSE-KMS encryption. This will require an existing KMS key to be selected or a new one to be created. Creating a key to use for this will incur a key "storage" fee of $1/month, so, I elected to not used a key here
  - In additional settings, enable log file validation. This tells CloudTrail to generate a log file hash for every log file generated. If there are any questions around if a log file was tampered with, a hash can be generated of the file and compared to the hash generated by CloudTrail
  - If one desires, SNS notifications can be delivered for every successful log file delivery. I don't see that as necessary
  - Click next

![Enabling SSO](/post/aws/securing-a-personal-aws-account/images/aws_ct_create_trail_details.png)

  - On the next screen, select what type of events to log: management, data and insights. To keep this free, I'm only logging management events. Depending on the use case, it could be worth enabling data events and insights either now or in the future. For personal use, the costs will probably be negligible. In enterprise, however, I have seen data event logging quickly becoming one of the most expensive line items in an AWS bill, so be careful with that one. Understand how S3 is being used and the possible cost of logging before just enabling it
  - Because I'm just logging management events, I'm only presented with configuration options for management events. With this being the first trail, and the first trail being free, logging everything makes sense. Additionally, with being a personal use account, the S3 costs incurred will be minimal, if not covered by the free tier. At enterprise use levels, logging it all will still probably not be too expensive and even long term storage in S3 will likely be low, however, consideration should be taken when ingesting all of this in a SIEM. I've seen KMS events account for the vast majority of CloudTrail where KMS is used heavily in S3 and where those S3 buckets have a significant amount of put, get and delete operations. CloudTrail accounts for almost 90% of the SIEM ingest license use
  - Click next

![Enabling SSO](/post/aws/securing-a-personal-aws-account/images/aws_ct_create_trail_details_2.png)

  - On the final screen, confirm the configuration and, if acceptable, create the trail

## Wrapping Up
That's really it for this one. I'm not going to go over details about using CloudTrail or at least looking at what a CloudTrail log file gives us in this post. I might dig in to that in a future post and how Amazon Athena can be used to help query and analyze the CloudTrail logs. For now, we're at least keeping a record of events in the event we need to review something later on.

In the next post we'll be looking at Amazon GuardDuty which provides "intelligent threat detection" by mining CloudTrail logs, VPC flow logs and AWS VPC DNS resolver logs and using machine learning to identify anomalous and malicious activity in an AWS account. The interesting thing with GuardDuty, is it doesn't actually require a CloudTrail trail to exist in order to do what it needs to, so one could argue, at least for a personal use account, that turning on CloudTrail is maybe not necessary. In all likelihood, the CloudTrail data will just sit in the S3 bucket, never getting looked at with personal use. Having said that, if you're wanting to learn AWS, it's definitely worth going through this exercise and at some point, looking through CloudTrail logs to understand what it's logging and what information might be useful - especially through a cloud security lens.

[part-1]: https://dariushall.com/post/aws/securing-a-personal-aws-account/secure-multi-account-setup-part-1/ "Part 1 - AWS For Personal Use/Learning: Secure Multi-Account Setup"
[part-2]: https://dariushall.com/post/aws/securing-a-personal-aws-account/iam-personal-accounts-part-2/ "Part 2 - AWS For Personal Use/Learning: Identity and Access Management"
[part-3]: https://dariushall.com/post/aws/securing-a-personal-aws-account/account-level-guardrails-part-3/ "Part 3 - AWS For Personal Use/Learning: Account Level Guardrails"
[part-5]: https://dariushall.com/post/aws/securing-a-personal-aws-account/intelligent-threat-detection-part-5/ "Part 5 - AWS For Personal Use/Learning: Intelligent Threat Detection"