
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet/less" type="text/css" href="https://dariushall.com/theme/stylesheet/style.less">
    <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.5.1/less.min.js" type="text/javascript"></script>

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="https://dariushall.com/theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="https://dariushall.com/theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="https://dariushall.com/theme/pygments/monokai.min.css">


  <link rel="stylesheet" type="text/css" href="https://dariushall.com/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://dariushall.com/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://dariushall.com/theme/font-awesome/css/solid.css">

    <link href="https://dariushall.com/static/custom.css" rel="stylesheet">

    <link href="https://dariushall.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Darius Hall Atom">


    <link rel="shortcut icon" href="http://localhost:8000/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="http://localhost:8000/images/favicon.ico" type="image/x-icon">

  

    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333">

<meta name="author" content="Darius" />
<meta name="description" content="Every time I set up a fresh install of an operating system as a result of a new computer or messing around with different OSes on existing systems, I end up having to set up the AWS CLI from scratch. I have multiple personal AWS accounts to use for learning …" />
<meta name="keywords" content="aws, cli, awscli, reference">


<meta property="og:site_name" content="Darius Hall"/>
<meta property="og:title" content="Configuring the AWS CLI"/>
<meta property="og:description" content="Every time I set up a fresh install of an operating system as a result of a new computer or messing around with different OSes on existing systems, I end up having to set up the AWS CLI from scratch. I have multiple personal AWS accounts to use for learning …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://dariushall.com/configuring-the-aws-cli.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2021-03-23 07:49:30.888286-06:00"/>
<meta property="article:modified_time" content="2021-03-23 07:49:30.888286-06:00"/>
<meta property="article:author" content="https://dariushall.com/author/darius.html">
<meta property="article:section" content="AWS"/>
<meta property="article:tag" content="aws"/>
<meta property="article:tag" content="cli"/>
<meta property="article:tag" content="awscli"/>
<meta property="article:tag" content="reference"/>
<meta property="og:image" content="http://localhost:8000/images/profile.jpg">

  <title>Darius Hall &ndash; Configuring the AWS CLI</title>

</head>
<body >
  <aside>
    <div>
      <a href="https://dariushall.com">
        <img src="http://localhost:8000/images/profile.jpg" alt="Darius Hall" title="Darius Hall">
      </a>

      <h1>
        <a href="https://dariushall.com">Darius Hall</a>
      </h1>

<p>My piece of the Internet</p>

      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="https://dariushall.com/pages/about.html">
                  about
                </a>
              </li>

            <li>
              <a target="_self" href="/category/aws" >AWS</a>
            </li>
            <li>
              <a target="_self" href="https://getpelican.com/" >Pelican</a>
            </li>
            <li>
              <a target="_self" href="https://palletsprojects.com/p/jinja/" >Jinja2</a>
            </li>
        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/dariushall/" target="_blank">
              <i class="fab fa-linkedin"></i>
            </a>
          </li>
          <li>
            <a  class="sc-github" href="https://github.com/dubiZA" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="/blog/feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="https://dariushall.com">Home</a>

      <a href="/archives">Archives</a>
      <a href="/categories">Categories</a>
      <a href="/tags">Tags</a>

      <a href="https://dariushall.com/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="configuring-the-aws-cli">Configuring the AWS CLI</h1>
    <p>
      Posted on March 23, 2021 in <a href="https://dariushall.com/category/aws.html">AWS</a>

    </p>
  </header>


  <div>
    <p>Every time I set up a fresh install of an operating system as a result of a new computer or messing around with different OSes on existing systems, I end up having to set up the AWS CLI from scratch. I have multiple personal AWS accounts to use for learning and running services that I want on a more resilient platform than running them on a server at home. It's always a pain to find the right doc pages for setting up the CLI with easy MFA assume role, so it's time to document that here.</p>
<h1>Setting Up the AWS Credentials File</h1>
<p>The first step is configuring the <code>~/.aws/credentials</code> file. AWS calls this the 'shared credentials file'. The way I use my accounts, I have set up an AWS Organizations organization. The organization master account is the 'front-door' to my other accounts through a 'master role' that can be assumed in all other accounts (including the org master account). I then have a single IAM user in the org master account which has limited IAM permissions, but which can assume the org master role in my several accounts. As such, the only stanza I have in my shared credentials file is:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>default<span class="o">]</span>
<span class="nv">aws_access_key_id</span> <span class="o">=</span> AKIAMYACCESSKEY
<span class="nv">aws_secret_access_key</span> <span class="o">=</span> mySeCREtacc3SSk3y+aws
</code></pre></div>

<p>The above stanza is then used for any CLI call made without specifying a CLI profile. As mentioned earlier, the IAM user to which this credential belongs can't do a whole heck of a lot, so some additional configuration is made in the <code>~/.aws/config</code> file. This file has several more stanzas in it, one of each account in which I want to be able to assume the master role. While I may not be following best practices here for IAM access, being a one man show with only personal accounts and no production sensitive activity going on, this setup suits my needs for now.</p>
<h1>Setting Up the AWS Config File</h1>
<p>The AWS Configuration file provides a means for defining profiles which I can then use with the <code>--profile</code> flag when making CLI calls. This file provides a means for defining which role should be used and where to look for the MFA device when needing to issue a command to a specific account. I have MFA required for all assumed role calls using the org master role I have set up. The config file looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>default<span class="o">]</span>
<span class="nv">region</span> <span class="o">=</span> us-east-1
<span class="nv">output</span> <span class="o">=</span> yaml

<span class="o">[</span>profile org-master<span class="o">]</span>
<span class="nv">region</span> <span class="o">=</span> us-east-1
<span class="nv">output</span> <span class="o">=</span> yaml
<span class="nv">role_arn</span> <span class="o">=</span> arn:aws:iam::210987654321:role/role_to_assume
<span class="nv">mfa_serial</span> <span class="o">=</span> arn:aws:iam::210987654321:mfa/iam_user_name
<span class="nv">source_profile</span> <span class="o">=</span> default

<span class="o">[</span>profile learning<span class="o">]</span>
<span class="nv">region</span> <span class="o">=</span> us-east-1
<span class="nv">output</span> <span class="o">=</span> yaml
<span class="nv">role_arn</span> <span class="o">=</span> arn:aws:iam::123456789012:role/role_to_assume
<span class="nv">mfa_serial</span> <span class="o">=</span> arn:aws:iam::210987654321:mfa/iam_user_name
<span class="nv">source_profile</span> <span class="o">=</span> default
</code></pre></div>

<p>The first stanza is a reference to the default "profile" and credentials set up in the shared credentials file. The second and third stanzas are named profiles, <code>org-master</code> and <code>larning</code> in this case, which tells the CLI how to access and assume the role required to use the profile. The important bits are <code>role_arn</code>, <code>mfa_serial</code> and <code>source_profile</code>. <code>role_arn</code> should be for the role in the account which you want to jump in to. The <code>mfa_serial</code> tells the CLI in which account the MFA device is configured and this should match the account specified in the <code>source_profile</code> section.</p>
<p>You will notice in the <code>org-master</code> profile, that the AWS account ID in the role ARN and MFA device ARN are the same. In this case, it's because I want to assume the priviledged role in the same account as the IAM user assuming the role.</p>
<p>In the <code>learning</code> profile, the account ID in the role ARN and MFA device ARN are different. This is because the IAM user defined in the <code>source_profile</code> (the default profile configured with the access key and secret access key for my IAM user) is to assume the role in the account with the ID specified in the <code>role_arn</code>. This all probably sounds terribly confusing. But once it's configured and you've issued <code>aws sts get-caller-identity</code> a few times, with and without the <code>--profile</code> flag, you will see how this all works.</p>
<h1>Scaling Things Up</h1>
<p>On my work laptop, my <code>~/.aws/config</code> and <code>~/.aws/credentials</code> files look a little different. In the shared credentials file, I have a couple of different profiles configured, beyond just the 'default'. The shared credentials file is largely the same, but with several stanzas for each IAM user with their own access key and secret access key's defined.</p>
<p>The configuration file changes a bit in this case if the IAM users are authorized to assume different roles in different accounts. The only things that really change though in the named profiles are the <code>mfa_serial</code> and <code>source_profile</code>. Instead of each named profile having the same configuration for tese two settings, they would be changed depending on the IAM user required to assume the roles in the various accounts.</p>
<h1>Wrapping Up</h1>
<p>Hopefully this makes sense to you, the reader. Mostly this is meant to be a quick write up so that I have it available to me next time I need to set this up.</p>
<p>For what it's worth, here are a handful of links that might come in useful:</p>
<ul>
<li><a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html">AWS CLI docs on AWS's docs site</a></li>
<li><a href="https://awscli.amazonaws.com/v2/documentation/api/latest/topic/config-vars.html">AWS CLI Command Line Reference config variables</a></li>
</ul>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://dariushall.com/tag/aws.html">aws</a>
      <a href="https://dariushall.com/tag/cli.html">cli</a>
      <a href="https://dariushall.com/tag/awscli.html">awscli</a>
      <a href="https://dariushall.com/tag/reference.html">reference</a>
    </p>
  </div>





</article>

    <footer>
<p>
  &copy; 2021  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/deed.en_US" target="_blank">Creative Commons Attribution-ShareAlike</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="https://dariushall.com/theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p><p>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Darius Hall ",
  "url" : "https://dariushall.com",
  "image": "http://localhost:8000/images/profile.jpg",
  "description": "The epic chronicles of Darius' forays in to tech, coding and, well, all the things"
}
</script>

</body>
</html>